<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSA Gate Pass Dashboard</title>
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- SUPABASE SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --psa-blue: #003399; --psa-yellow: #ffcc00; --bg-gray: #f4f7f9; }
        body { background-color: var(--bg-gray); font-family: 'Segoe UI', sans-serif; }
        .psa-header { background-color: var(--psa-blue); color: white; padding: 15px 25px; border-bottom: 5px solid var(--psa-yellow); display: flex; align-items: center; justify-content: space-between; }
        .section-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .section-title { font-weight: 700; color: var(--psa-blue); margin-bottom: 20px; text-transform: uppercase; border-left: 5px solid var(--psa-yellow); padding-left: 15px; }
        .btn-psa-yellow { background-color: var(--psa-yellow); color: var(--psa-blue); font-weight: 700; border: none; }
        .btn-psa-yellow:hover { background-color: #e6b800; }
        .clock-container { background-color: var(--psa-blue); padding: 15px; border-radius: 10px; border: 2px solid var(--psa-yellow); text-align: center; color: white; }
        .clock-time { font-family: 'Courier New', monospace; font-size: 2.2rem; font-weight: bold; color: var(--psa-yellow); }
        .nav-tabs .nav-link { font-weight: bold; color: #666; }
        .nav-tabs .nav-link.active { color: var(--psa-blue); border-top: 4px solid var(--psa-blue); }
        .table { font-size: 0.85rem; vertical-align: middle; }
        
        /* Modal Styling */
        .modal-content { border: none; border-radius: 15px; }
        .modal-header { border-bottom: none; padding-bottom: 0; }
        .modal-footer { border-top: none; justify-content: center; padding-bottom: 25px; }
        .confirm-icon { font-size: 3rem; color: var(--psa-blue); margin-bottom: 15px; }
        .sticky-header th { position: sticky; top: 0; z-index: 10; }

        /* USER BADGE STYLE */
        .user-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>

    <div class="psa-header">
        <div>
            <small class="d-block text-white-50 text-uppercase">Republic of the Philippines</small>
            <h4 class="m-0 fw-bold">Philippine Statistics Authority</h4>
        </div>
        <div class="d-flex align-items-center gap-2">
            <!-- CURRENT USER INDICATOR ADDED HERE (FIXED STYLE) -->
            <div id="currentUserDisplay" class="user-badge me-3 d-none d-md-flex"></div>

            <!-- ADMIN BUTTON (Hidden by default, shown by app.js if Admin) -->
            <a href="admin.html" id="adminPanelBtn" class="btn btn-warning btn-sm fw-bold" style="display:none;">
                <i class="fa fa-user-shield"></i> Manage Users
            </a>
            <button id="logoutBtn" class="btn btn-outline-light btn-sm"><i class="fa fa-power-off"></i> Logout</button>
        </div>
    </div>

    <div class="container-fluid mt-4">

        <div class="row">
            <!-- 2. ISSUANCE SECTION -->
            <div class="col-lg-8">
                <div class="section-card">
                    <div class="section-title">New Gate Pass Issuance</div>
                    
                    <!-- Tabs for Manual vs Bulk -->
                    <ul class="nav nav-tabs mb-3" id="issueTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manualEntry" type="button">Manual Entry</button>
                        </li>
                        <!-- BULK IMPORT TAB (Hidden by default, shown via app.js for Admin) -->
                        <li class="nav-item" role="presentation" id="bulkImportNav" style="display:none;">
                            <button class="nav-link" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulkImport" type="button">Bulk Inventory Import</button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- TAB 1: MANUAL ENTRY -->
                        <div class="tab-pane fade show active" id="manualEntry">
                            <form id="issuanceForm">
                                <div class="row g-2 mb-3">
                                    <div class="col-md-6"><label class="small fw-bold">Borrower's Name*</label><input type="text" id="borrower" class="form-control" required></div>
                                    <div class="col-md-6"><label class="small fw-bold">Guard Out*</label><input type="text" id="guardOut" class="form-control" required></div>
                                    <div class="col-md-4"><label class="small fw-bold">Destination*</label><input type="text" id="destination" class="form-control" required></div>
                                    <div class="col-md-4"><label class="small fw-bold">Project*</label><input type="text" id="project" class="form-control"></div>
                                    <div class="col-md-4"><label class="small fw-bold">Due Date*</label><input type="date" id="dueDate" class="form-control" required></div>
                                </div>
                                
                                <div class="p-3 bg-light border rounded mb-3">
                                    <div class="row g-2 align-items-end">
                                        <div class="col-md-3"><label class="small fw-bold">Serial No.*</label><input type="text" id="serial" class="form-control"></div>
                                        <div class="col-md-3"><label class="small fw-bold">Property No.</label><input type="text" id="propertyNum" class="form-control"></div>
                                        <div class="col-md-3"><label class="small fw-bold">Description*</label><input type="text" id="desc" class="form-control"></div>
                                        <div class="col-md-3"><label class="small fw-bold">Asset Tag</label><input type="text" id="asset" class="form-control"></div>
                                        <div class="col-12 mt-3"><button type="button" id="addToCartBtn" class="btn btn-psa-yellow w-100">+ ADD ITEM TO LIST</button></div>
                                    </div>
                                </div>
                            </form>

                            <table class="table table-sm table-bordered">
                                <thead class="table-light"><tr><th>Serial</th><th>Property No.</th><th>Description</th><th>Asset</th><th class="text-center">Action</th></tr></thead>
                                <tbody id="cartTableBody"></tbody>
                            </table>
                            <button id="issueBtn" class="btn btn-primary w-100 py-2 fw-bold" disabled>ISSUE GATE PASS</button>
                        </div>

                        <!-- TAB 2: BULK EXCEL IMPORT -->
                        <div class="tab-pane fade" id="bulkImport">
                            <div class="alert alert-info small">
                                <i class="fa fa-info-circle me-2"></i> Upload an Excel file (.xlsx) with columns: <b>serial_no</b>, <b>property_no</b>, <b>description</b>, <b>asset_no</b>.
                            </div>
                            <input type="file" id="inventoryFile" class="form-control mb-3" accept=".xlsx">
                            <button id="processImportBtn" class="btn btn-info text-white fw-bold w-100 mb-3"><i class="fa fa-magnifying-glass me-2"></i> PREVIEW DATA</button>
                            
                            <!-- Preview Table -->
                            <div id="importPreview" class="table-responsive border rounded mb-3" style="max-height: 300px; display:none;">
                                <table class="table table-sm table-striped mb-0">
                                    <thead class="table-dark sticky-header">
                                        <tr><th>Serial</th><th>Property No.</th><th>Description</th><th>Asset</th></tr>
                                    </thead>
                                    <tbody id="importBody"></tbody>
                                </table>
                            </div>
                            
                            <button id="saveBulkBtn" class="btn btn-success w-100 fw-bold" style="display:none;"><i class="fa fa-upload me-2"></i> SAVE TO MASTER INVENTORY</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. SIDEBAR -->
            <div class="col-lg-4">
                <div class="section-card text-center">
                    <div class="section-title">System Time</div>
                    <div class="clock-container">
                        <div id="clockDate" class="fw-bold opacity-75">---</div><div id="clockTime" class="clock-time">00:00:00</div>
                    </div>
                </div>

                <div id="overdueAlert" class="alert alert-success text-center fw-bold">ALL ON SCHEDULE</div>

                <div class="section-card">
                    <div class="section-title">Return Property</div>
                    <label class="small fw-bold">Serial No.*</label><input type="text" id="returnSerial" class="form-control mb-2" placeholder="Auto-fills from table">
                    <label class="small fw-bold">Guard Name (In)*</label><input type="text" id="guardIn" class="form-control mb-2" placeholder="Guard Name">
                    <button id="returnBtn" class="btn btn-warning w-100 fw-bold">SUBMIT RETURN</button>
                </div>
            </div>
        </div>

        <!-- 4. RECORDS LOGS -->
        <div class="section-card">
            <ul class="nav nav-tabs mb-3" id="pills-tab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#activeTab">Active Records</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#historyTab">History Log</button></li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="activeTab">
                    
                    <!-- BATCH SELECTION & SEARCH TOOLBAR -->
                    <div class="d-flex mb-3 justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <span class="small fw-bold me-2 text-secondary">Batch Selection:</span>
                            <button id="selectAllBtn" class="btn btn-info btn-sm text-white"><i class="fa fa-check-double me-1"></i> Select All</button>
                            <button id="deselectAllBtn" class="btn btn-outline-secondary btn-sm"><i class="fa fa-xmark me-1"></i> Deselect All</button>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="small fw-bold align-self-center">Search:</span>
                            <input type="text" id="tableSearch" class="form-control form-control-sm" placeholder="" style="width: 200px;">
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>Sel</th><th>ID</th><th>Borrower</th><th>Description</th><th>Serial</th><th>Property No.</th><th>Asset</th><th>Destination</th><th>Project</th><th>Time Out</th><th>Guard Out</th><th>Due Date</th><th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="activeTableBody"></tbody>
                        </table>
                    </div>

                    <!-- FOOTER EXPORT BAR -->
                    <div class="d-flex justify-content-end align-items-center mt-3 pt-3 border-top">
                        <span id="selectionCount" class="me-3 fw-bold text-primary">0 item(s) selected</span>
                        <button id="openExportModalBtn" class="btn btn-success fw-bold px-4"><i class="fa fa-download me-2"></i> EXPORT SELECTED</button>
                    </div>
                </div>

                <div class="tab-pane fade" id="historyTab">
                    <!-- HISTORY TOOLBAR -->
                    <div class="d-flex mb-3 justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <span class="small fw-bold me-2 text-secondary">Batch Selection:</span>
                            <button id="selectAllHistoryBtn" class="btn btn-info btn-sm text-white"><i class="fa fa-check-double me-1"></i> Select All</button>
                            <button id="deselectAllHistoryBtn" class="btn btn-outline-secondary btn-sm"><i class="fa fa-xmark me-1"></i> Deselect All</button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover table-bordered align-middle">
                            <thead class="table-secondary">
                                <tr>
                                    <th>Sel</th><th>ID</th><th>Borrower</th><th>Description</th><th>Serial</th><th>Property No.</th><th>Time Out</th><th>Time Returned</th><th>Guard In</th><th>Destination</th><th>Project</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody"></tbody>
                        </table>
                    </div>
                    
                    <!-- HISTORY EXPORT FOOTER -->
                    <div class="d-flex justify-content-end align-items-center mt-3 pt-3 border-top">
                        <span id="historySelectionCount" class="me-3 fw-bold text-primary">0 item(s) selected</span>
                        <button id="openExportHistoryModalBtn" class="btn btn-success fw-bold px-4"><i class="fa fa-download me-2"></i> EXPORT HISTORY</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CUSTOM CONFIRMATION MODAL -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
          <div class="modal-body text-center p-4">
            <div class="confirm-icon"><i class="fa fa-circle-question"></i></div>
            <h4 class="fw-bold mb-3" id="confirmTitle">Confirm Action</h4>
            <p class="text-muted mb-0" id="confirmText">Are you sure you want to proceed?</p>
          </div>
          <div class="modal-footer bg-light border-0">
            <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary px-4 fw-bold" id="confirmBtnYes">Confirm</button>
          </div>
        </div>
      </div>
    </div>

    <!-- EXPORT OPTIONS MODAL -->
    <div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
          <div class="modal-header border-0 pb-0">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center pt-0 pb-4 px-4">
            <h5 class="fw-bold mb-4" id="exportModalTitle">Ready to export 0 selected items.</h5>
            <div class="d-grid gap-3">
                <button id="btnExportGatePass" class="btn btn-danger py-2 fw-bold text-start ps-4"><i class="fa fa-file-pdf me-3"></i> Gate Pass (PDF)</button>
                <button id="btnExportTransmittal" class="btn btn-primary py-2 fw-bold text-start ps-4" style="background-color: #003399;"><i class="fa fa-file-export me-3"></i> Transmittal Form (PDF)</button>
                <button id="btnExportAckReceipt" class="btn btn-warning py-2 fw-bold text-white text-start ps-4"><i class="fa fa-file-signature me-3"></i> Acknowledgement Receipt (PDF)</button>
                <button id="btnExportExcel" class="btn btn-success py-2 fw-bold text-start ps-4"><i class="fa fa-file-excel me-3"></i> Export to Excel</button>
            </div>
          </div>
          <div class="modal-footer border-0 justify-content-center">
             <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SECURE DATE VALIDATION SCRIPT -->
    <script>
        (async function secureDate() {
            const dateInput = document.getElementById('dueDate');
            const issueBtn = document.getElementById('issueBtn');
            let serverDate = new Date().toISOString().split('T')[0];

            try {
                const response = await fetch('https://worldtimeapi.org/api/timezone/Asia/Manila');
                if (response.ok) {
                    const data = await response.json();
                    serverDate = data.datetime.split('T')[0];
                }
            } catch (e) {
                console.warn("Time API failed, falling back to local.");
            }

            if(dateInput) {
                dateInput.setAttribute('min', serverDate);
                dateInput.addEventListener('change', () => {
                    if (dateInput.value < serverDate) {
                        alert("Invalid Date: You cannot select a date in the past.");
                        dateInput.value = serverDate;
                    }
                });
            }

            if (issueBtn) {
                issueBtn.addEventListener('click', (e) => {
                    const selectedDate = dateInput ? dateInput.value : '';
                    if (selectedDate && selectedDate < serverDate) {
                        e.stopImmediatePropagation();
                        e.preventDefault();
                        alert(`Security Warning: Past dates are not allowed.\n\nSystem Date: ${serverDate}`);
                        if(dateInput) dateInput.value = serverDate;
                    }
                }, true);
            }
        })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="app.js"></script>
</body>
</html>